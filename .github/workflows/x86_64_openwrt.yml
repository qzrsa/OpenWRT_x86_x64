name: immortalwrt_x86_64

# è§¦å‘æ¡ä»¶ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©16:00ï¼‰å’Œæ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: 0 16 * * *
  workflow_dispatch:

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt  # å›ºä»¶æºä»£ç ä»“åº“åœ°å€
  REPO_BRANCH: openwrt-24.10  # è¦ä½¿ç”¨çš„åˆ†æ”¯
  CONFIG_FILE: immortalwrt/x86_64/defconfig.txt  # é…ç½®æ–‡ä»¶è·¯å¾„
  DIY_P1_SH: immortalwrt/diy-part1.sh  # è‡ªå®šä¹‰è„šæœ¬1è·¯å¾„
  DIY_P2_SH: immortalwrt/diy-part2.sh  # è‡ªå®šä¹‰è„šæœ¬2è·¯å¾„
  UPLOAD_FIRMWARE: true  # æ˜¯å¦ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true  # æ˜¯å¦å‘å¸ƒRelease
  TZ: Asia/Shanghai  # æ—¶åŒºè®¾ç½®
  OPENWRT_NAME: immortalwrt  # å›ºä»¶åç§°
  OPENWRT_NAME1: x86_64  # å›ºä»¶æ¶æ„

jobs:
  build:
    runs-on: ubuntu-22.04  # ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒ

    steps:
    # æœ€å¤§åŒ–æ„å»ºç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512  # æ ¹åˆ†åŒºä¿ç•™ç©ºé—´
        swap-size-mb: 1024  # äº¤æ¢ç©ºé—´å¤§å°
        remove-dotnet: 'true'  # æ˜¯å¦ç§»é™¤dotnet

    # æ£€å‡ºé¡¹ç›®åˆ†æ”¯
    - name: Check out the project branch
      uses: actions/checkout@main

    # åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
    - name: Initialize the compilation environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        ( sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex g++ gawk gcc-multilib gettext \
        git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig libpython3-dev aria2 jq subversion qemu-utils ccache rename libelf-dev
        sudo -E apt-get -qq purge azure-cli ghc* zulu* hhvm llvm* firefox powershell openjdk* dotnet* google* mysql* php* android* rename speedtest-cli
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean ) &
        sudo timedatectl set-timezone "$TZ"  # è®¾ç½®æ—¶åŒº

    # åˆå§‹åŒ–ç¯å¢ƒå¹¶æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    - name: Initialize Environment and Display System Info
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        chmod +x $OPENWRT_NAME/*.sh  # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
        $GITHUB_WORKSPACE/$OPENWRT_NAME/system-Information.sh  # æ‰§è¡Œç³»ç»Ÿä¿¡æ¯è„šæœ¬

    # ä¸‹è½½å›ºä»¶æºä»£ç 
    - name: Download firmware source code
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt  # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„å›ºä»¶æºä»£ç 

    # æ›´æ–°å¹¶å®‰è£…feeds
    - name: Update & install feeds
      working-directory: ./openwrt  # æŒ‡å®šå·¥ä½œç›®å½•
      run: |
        ./scripts/feeds update -a  # æ›´æ–°æ‰€æœ‰feeds
        ./scripts/feeds install -a  # å®‰è£…æ‰€æœ‰feeds

    # åŠ è½½feeds.conf.default
    - name: Load feeds.conf.default
      run: |
        chmod +x $OPENWRT_NAME/*.sh  # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
        cd openwrt  # è¿›å…¥openwrtç›®å½•
        $GITHUB_WORKSPACE/$DIY_P1_SH  # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬1

    # åŠ è½½é…ç½®æ–‡ä»¶
    - name: Load config
      run: |
        [ -e "$CONFIG_FILE" ] && cat "$CONFIG_FILE" > openwrt/.config  # å¦‚æœé…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œå°†å…¶å†…å®¹å¤åˆ¶åˆ°.openwrt.config
        chmod +x $OPENWRT_NAME/*.sh && cd openwrt  # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿›å…¥openwrtç›®å½•
        $GITHUB_WORKSPACE/$DIY_P2_SH  # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬2

    # ä¸‹è½½å®‰è£…åŒ…
    - name: Download the installation package
      id: package
      run: |
        cd openwrt  # è¿›å…¥openwrtç›®å½•
        make defconfig  # ç”Ÿæˆé»˜è®¤é…ç½®
        cat .config  # æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹
        make download -j$(nproc)  # å¤šçº¿ç¨‹ä¸‹è½½å®‰è£…åŒ…
        find dl -size -1024c -exec ls -l {} \;  # æŸ¥æ‰¾å°äº1024å­—èŠ‚çš„æ–‡ä»¶å¹¶æ˜¾ç¤ºä¿¡æ¯
        find dl -size -1024c -exec rm -f {} \;  # åˆ é™¤å°äº1024å­—èŠ‚çš„æ–‡ä»¶

    # ç¼–è¯‘å›ºä»¶
    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt  # è¿›å…¥openwrtç›®å½•
        echo -e "$(nproc) thread compile"  # æ˜¾ç¤ºç¼–è¯‘çº¿ç¨‹æ•°
        make -j$(nproc) || make -j1 || make -j1 V=s  # å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹ç¼–è¯‘
        echo "date1=$(date +'%Y.%m.%d')" >> $GITHUB_ENV  # å°†å½“å‰æ—¥æœŸå†™å…¥ç¯å¢ƒå˜é‡
        echo "date2=$(date "+%Yå¹´%mæœˆ%dæ—¥")" >> $GITHUB_ENV  # å°†å½“å‰æ—¥æœŸï¼ˆä¸­æ–‡æ ¼å¼ï¼‰å†™å…¥ç¯å¢ƒå˜é‡

    # ç»„ç»‡å¹¶é‡å‘½åæ–‡ä»¶
    - name: Organize and Rename Files
      id: organize
      if: ${{ env.UPLOAD_FIRMWARE == 'true' && !cancelled() }}  # åªæœ‰å½“UPLOAD_FIRMWAREä¸ºtrueä¸”ä»»åŠ¡æœªå–æ¶ˆæ—¶æ‰§è¡Œ
      run: |
        cd openwrt/bin/targets/x86/64  # è¿›å…¥ç›®æ ‡ç›®å½•
        rm -rf packages *rootfs.tar.gz *rootfs.img.gz *combined.img.gz *.bin *.config *.buildinfo *.json sha256sums *.manifest  # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV  # å°†å½“å‰ç›®å½•è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡
        echo "status=success" >> $GITHUB_OUTPUT  # è®¾ç½®è¾“å‡ºçŠ¶æ€ä¸ºæˆåŠŸ

    # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
    - name: Generate release tags
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()  # åªæœ‰å½“UPLOAD_RELEASEä¸ºtrueä¸”ä»»åŠ¡æœªå–æ¶ˆæ—¶æ‰§è¡Œ
      run: |
        echo "release_tag=${{ env.date2 }}" >> $GITHUB_OUTPUT  # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        touch release.txt  # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
        echo "ğŸ“¥ å›ºä»¶ä¸‹è½½" >> release.txt  # å†™å…¥å‘å¸ƒè¯´æ˜å†…å®¹
        echo "status=success" >> $GITHUB_OUTPUT  # è®¾ç½®è¾“å‡ºçŠ¶æ€ä¸ºæˆåŠŸ

    # åˆ›å»ºGitæ ‡ç­¾å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“
    - name: Create Git tag
      if: steps.tag.outputs.status == 'success' && !cancelled()  # åªæœ‰å½“ç”Ÿæˆæ ‡ç­¾æ­¥éª¤æˆåŠŸä¸”ä»»åŠ¡æœªå–æ¶ˆæ—¶æ‰§è¡Œ
      run: |
        git config --global user.name "GitHub Actions"  # è®¾ç½®å…¨å±€ç”¨æˆ·å
        git config --global user.email "actions@github.com"  # è®¾ç½®å…¨å±€ç”¨æˆ·é‚®ç®±
        git tag ${{ steps.tag.outputs.release_tag }}  # åˆ›å»ºGitæ ‡ç­¾
        git push origin ${{ steps.tag.outputs.release_tag }}  # å°†æ ‡ç­¾æ¨é€åˆ°è¿œç¨‹ä»“åº“

    # å‘å¸ƒåˆ°Release
    - name: Publish to release
      uses: softprops/action-gh-release@v1  # ä½¿ç”¨action-gh-releaseå‘å¸ƒRelease
      if: steps.tag.outputs.status == 'success' && !cancelled()  # åªæœ‰å½“ç”Ÿæˆæ ‡ç­¾æ­¥éª¤æˆåŠŸä¸”ä»»åŠ¡æœªå–æ¶ˆæ—¶æ‰§è¡Œ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨GitHubä»¤ç‰Œ
      with:
        files: ${{ env.FIRMWARE }}/*  # è¦å‘å¸ƒçš„æ–‡ä»¶
        name: ${{ env.date2 }}  # Releaseåç§°
        tag_name: ${{ steps.tag.outputs.release_tag }}  # æ ‡ç­¾åç§°
        body_path: release.txt  # å‘å¸ƒè¯´æ˜æ–‡ä»¶è·¯å¾„
